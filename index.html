<script>
    // ... (весь остальной код остается прежним) ...

    // НОВАЯ ФУНКЦИЯ: Запрос разрешения и запуск MediaPipe Camera
    async function requestCameraPermissionAndStart() {
      const videoElement = document.getElementById('selfieVideo');
      const tipEl = document.getElementById('selfieTip');
      tipEl.innerText = "Запрашиваем доступ к камере..."; // Обновляем подсказку
      
      stopSelfieCamera(); // Гарантируем, что предыдущий поток остановлен

      try {
        // 1. ПРИНУДИТЕЛЬНЫЙ ЗАПРОС РАЗРЕШЕНИЯ
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'user', // Запрос фронтальной камеры
                width: { ideal: 1280 },
                height: { ideal: 720 }
            } 
        });
        
        // Камера успешно запущена
        videoElement.srcObject = stream;
        await videoElement.play();
        tipEl.innerText = "Камера активна. Идет наложение маски."; // Обновляем подсказку

        // 2. Инициализация и запуск MediaPipe FaceMesh
        if (!faceMesh) {
            faceMesh = new FaceMesh.FaceMesh({
                locateFile: (file) => "https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/" + file
            });
            faceMesh.setOptions({
                maxNumFaces: 1,
                refineLandmarks: true,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            faceMesh.onResults(onSelfieResults);
        }

        // 3. Запуск цикла обработки кадров с помощью MediaPipe Camera
        selfieCamera = new Camera(videoElement, {
            onFrame: async () => {
                await faceMesh.send({ image: videoElement });
            },
            width: videoElement.videoWidth || 1280,
            height: videoElement.videoHeight || 720
        });
        
        selfieCamera.start();

      } catch (error) {
        // Пользователь отказал в доступе или произошла другая ошибка
        console.error("Ошибка при запросе или запуске камеры:", error);
        tipEl.innerText = "ОШИБКА: Доступ к камере заблокирован. Разрешите доступ в настройках браузера или попробуйте HTTPS.";
        alert("Не удалось получить доступ к камере. Пожалуйста, разрешите использование камеры в настройках браузера и убедитесь, что страница открыта по HTTPS или на localhost.");
      }
    }

    // ... (весь остальной код остается прежним) ...

</script>
