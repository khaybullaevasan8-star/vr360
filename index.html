<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>VR 360 –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –¢—É—Ä</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
html,body{
  margin:0;
  height:100%;
  background:#f5f0e6;
  font-family:Georgia,serif;
  overflow:hidden
}
.screen{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column
}
.card{
  background:rgba(245,237,220,.95);
  border:2px solid #a88f61;
  border-radius:12px;
  padding:18px;
  box-shadow:0 0 20px rgba(50,30,10,.4)
}
.btn{
  padding:6px 12px;
  font-size:.85rem;
  margin:4px;
  border-radius:8px;
  cursor:pointer;
  background:linear-gradient(#c1a675,#a88f61);
  border:1px solid #7b6643
}
video,canvas{
  width:100%;
  max-width:600px;
  border-radius:12px
}
.masks-row{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  justify-content:center
}
#capturedPreview{
  max-width:90%;
  margin-top:8px;
  display:none
}
</style>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
</head>

<body>

<div id="langScreen" class="screen">
  <div class="card">
    <h3>–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫</h3>
    <button class="btn" onclick="showGreeting('ru')">–†—É—Å—Å–∫–∏–π</button>
    <button class="btn" onclick="showGreeting('en')">English</button>
    <button class="btn" onclick="showGreeting('uz')">O‚Äòzbekcha</button>
  </div>
</div>

<div id="greetingScreen" class="screen" style="display:none">
  <div class="card">
    <h3 id="greetingText"></h3>
    <button class="btn" id="selfieBtn"></button>
    <button class="btn" id="backFromGreetingBtn"></button>
  </div>
</div>

<div id="selfieScreen" class="screen" style="display:none">
  <div class="card">
    <h3 id="selfieTitle"></h3>

    <video id="selfieVideo" autoplay playsinline muted></video>
    <canvas id="selfieCanvas"></canvas>

    <div class="masks-row">
      <button class="btn" id="maskNoneBtn">–ë–µ–∑ –º–∞—Å–∫–∏</button>
      <button class="btn" id="mask1Btn">Masira1</button>
      <button class="btn" id="mask2Btn">Masira2</button>
    </div>

    <div>
      <button class="btn" id="takePhotoBtn">üì∏</button>
      <button class="btn" id="savePhotoBtn">üíæ</button>
      <button class="btn" id="backFromSelfieBtn">üîô</button>
    </div>

    <img id="capturedPreview">
    <img id="bgPanorama" src="panorama1.png" style="display:none">
  </div>
</div>

<script>
let currentScreen="langScreen";
let currentLang="ru";
let faceMesh=null;
let camera=null;
let currentMaskImage=null;
let lastCapture=null;
let frameCounter=0;

function showScreen(id){
  if(currentScreen==="selfieScreen") stopCamera();
  document.getElementById(currentScreen).style.display="none";
  document.getElementById(id).style.display="flex";
  currentScreen=id;
}

function showGreeting(lang){
  currentLang=lang;
  showScreen("greetingScreen");

  const txt={
    ru:["–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ","–°–¥–µ–ª–∞—Ç—å —Å–µ–ª—Ñ–∏","–ù–∞–∑–∞–¥"],
    en:["Choose action","Take selfie","Back"],
    uz:["Amalni tanlang","Selfi olish","Ortga"]
  }[lang];

  greetingText.innerText=txt[0];
  selfieBtn.innerText=txt[1];
  backFromGreetingBtn.innerText=txt[2];

  selfieBtn.onclick=()=>showSelfieScreen();
  backFromGreetingBtn.onclick=()=>showScreen("langScreen");
}

function showSelfieScreen(){
  showScreen("selfieScreen");
  initFaceMesh();
}

function initFaceMesh(){
  if(faceMesh){ startCamera(); return; }

  faceMesh=new FaceMesh.FaceMesh({
    locateFile:f=>"https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/"+f
  });

  faceMesh.setOptions({
    maxNumFaces:1,
    refineLandmarks:false
  });

  faceMesh.onResults(onResults);
  startCamera();
}

function startCamera(){
  const video=selfieVideo;

  camera=new Camera(video,{
    width:640,
    height:480,
    onFrame:async()=>{
      frameCounter++;
      if(frameCounter%2!==0) return; // FPS OPTIMIZATION
      await faceMesh.send({image:video});
    }
  });

  camera.start();
}

function stopCamera(){
  if(camera){camera.stop();camera=null;}
  if(selfieVideo.srcObject){
    selfieVideo.srcObject.getTracks().forEach(t=>t.stop());
    selfieVideo.srcObject=null;
  }
}

function onResults(res){
  if(!selfieVideo.videoWidth) return;
  const c=selfieCanvas,ctx=c.getContext("2d");
  c.width=selfieVideo.videoWidth;
  c.height=selfieVideo.videoHeight;

  ctx.drawImage(bgPanorama,0,0,c.width,c.height);
  ctx.drawImage(res.image,0,0,c.width,c.height);

  if(!res.multiFaceLandmarks?.length || !currentMaskImage) return;

  const f=res.multiFaceLandmarks[0];
  const p=i=>({x:f[i].x*c.width,y:f[i].y*c.height});
  const l=p(33),r=p(263),t=p(10),b=p(152);

  const w=Math.hypot(r.x-l.x,r.y-l.y)*3;
  const h=Math.hypot(b.y-t.y,b.x-t.x)*1.4;
  const cx=(l.x+r.x)/2;
  const cy=(t.y+b.y)/2;
  const a=Math.atan2(r.y-l.y,r.x-l.x);

  ctx.save();
  ctx.translate(cx,cy);
  ctx.rotate(a);
  ctx.drawImage(currentMaskImage,-w/2,-h/2,w,h);
  ctx.restore();
}

maskNoneBtn.onclick=()=>currentMaskImage=null;
mask1Btn.onclick=()=>loadMask("masira1.png");
mask2Btn.onclick=()=>loadMask("masira2.png");

function loadMask(src){
  const i=new Image();
  i.src=src;
  i.onload=()=>currentMaskImage=i;
}

takePhotoBtn.onclick=()=>{
  lastCapture=selfieCanvas.toDataURL();
  capturedPreview.src=lastCapture;
  capturedPreview.style.display="block";
}

savePhotoBtn.onclick=()=>{
  const a=document.createElement("a");
  a.href=lastCapture||selfieCanvas.toDataURL();
  a.download="selfie.png";
  a.click();
}

backFromSelfieBtn.onclick=()=>{
  stopCamera();
  showScreen("greetingScreen");
}
</script>

</body>
</html>
